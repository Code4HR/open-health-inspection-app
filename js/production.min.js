"use strict";var openHealthDataApp=angular.module("openHealthDataApp",["ngRoute","openHealthDataAppControllers","ngAnimate","openHealthDataServices","openHealthDataAppFilters","google-maps"]);openHealthDataApp.config(["$routeProvider",function(a){a.when("/vendor/:id",{templateUrl:"partials/restaurantDetailView.html",controller:"restaurantDetailCtrl"}).otherwise({redirectTo:"/"})}]);var openHealthDataAppControllers=angular.module("openHealthDataAppControllers",[]);openHealthDataAppControllers.controller("mapCtrl",["$scope","$rootScope","$http","$q","Geosearch","Search","$filter",function(a,b,c,d,e,f,g){a.map=e.map={center:{latitude:36.84701,longitude:-76.29243},zoom:18},console.log(e.map),a.dist=1e3,a.showPosition=function(c){e.map.center.latitude=c.coords.latitude,e.map.center.longitude=c.coords.longitude,a.results=e.results=e.query({lat:a.map.center.latitude,lon:a.map.center.longitude,dist:a.dist},function(){e.results=_.values(e.results),e.results.forEach(function(a){console.log(a.dist),a.dist=621371e-9*a.dist}),e.results=g("orderBy")(e.results,"dist"),b.$broadcast("geosearchFire")})},a.showError=function(){console.log("error")},a.getLocation=function(){navigator.geolocation?navigator.geolocation.getCurrentPosition(a.showPosition,a.showError):a.error="Geolocation is not supported by this browser."},a.getLocation(),b.toRad=function(a){return a*Math.PI/180},b.distanceCalculation=function(b){var c=b.latitude,d=b.longitude,e=a.map.center.latitude,f=a.map.center.longitude,g=6378.137,h=a.toRad(c-e),i=a.toRad(d-f);e=a.toRad(e),c=a.toRad(c);var j=Math.sin(h/2)*Math.sin(h/2)+Math.sin(i/2)*Math.sin(i/2)*Math.cos(e)*Math.cos(c),k=2*Math.atan2(Math.sqrt(j),Math.sqrt(1-j)),l=g*k;return.62137*l}}]),openHealthDataAppControllers.controller("restaurantDetailCtrl",["$scope","$routeParams","$http","$location","Geosearch","Inspections",function(a,b,c,d,e,f){a.results=f.query({vendorid:b.id},function(){e.map.center=a.results[b.id].coordinates,setTimeout(function(){a.$watch(e.map.center,function(){d.path("/#")},!0)},1e3)})}]),openHealthDataAppControllers.controller("searchCtrl",["$scope","$rootScope","Search","$filter",function(a,b,c,d){a.nameSearch=function(){console.log("Searching for "+a.query+"."),c.results=c.query({name:a.query},function(){c.results=_.values(c.results),c.results.forEach(function(a,d){_.isUndefined(a.coordinates)?c.results.splice(d,1):a.dist=b.distanceCalculation(a.coordinates)}),c.results=d("orderBy")(c.results,"dist"),b.$broadcast("searchFire")})}}]),openHealthDataAppControllers.controller("searchResultsCtrl",["$scope","$rootScope","Search","Geosearch",function(a,b,c,d){b.$on("searchFire",function(){console.log("searchFire heard"),console.log(c.results),a.results=c.results,b.isVisible=!0,angular.element("#nottalink").trigger("focus")}),b.$on("geosearchFire",function(){console.log("geosearchFire heard"),console.log(d.results),a.results=d.results,b.isVisible=!0,angular.element("#nottalink").trigger("focus")}),a.map=d.map,b.isVisible=!1,a.hasFocus=function(){},a.lostFocus=function(){setTimeout(function(){b.isVisible=!1,console.log(b.isVisible),a.$apply()},100)}}]),openHealthDataApp.directive("bindOnce",function(){return{scope:!0,link:function(a){setTimeout(function(){a.$destroy()},0)}}}),angular.module("openHealthDataAppFilters",[]).filter("was",function(){return function(a){return a?"was":"wasn't"}});var openHealthDataServices=angular.module("openHealthDataServices",["ngResource"]);openHealthDataServices.factory("Inspections",["$resource",function(a){return a("http://api.openhealthinspection.com/inspections?vendorid=:vendorid",{},{query:{method:"JSONP",params:{vendorid:"",callback:"JSON_CALLBACK"}}})}]),openHealthDataServices.factory("Geosearch",["$resource",function(a){return a("http://api.openhealthinspection.com/vendors?lat=:lat&lng=:lon&dist=:dist",{},{query:{method:"JSONP",params:{lat:"36",lon:"-72",dist:"1000",callback:"JSON_CALLBACK"}}})}]),openHealthDataServices.factory("Search",["$resource",function(a){return a("http://api.openhealthinspection.com/vendors",{},{query:{method:"JSONP",params:{callback:"JSON_CALLBACK"}}})}]);